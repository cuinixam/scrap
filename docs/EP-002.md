# EP-002: Bucket Management Registry

| Status | Draft |
| :--- | :--- |
| **Author** | User |
| **Created** | 2026-02-13 |
| **Updated** | 2026-02-13 |

## Abstract

This proposal introduces a persistent registry (`buckets.json`) to track and manage bucket repositories in Poks. This ensures specific bucket URLs are consistently mapped to local directory names, replacing the ad-hoc "temp" bucket creation logic and providing a reliable source of truth for installed buckets.

## Motivation

Currently, when a user installs an app using a direct bucket URL (e.g., `poks install app --bucket https://...`), Poks creates a temporary bucket named "temp". This has several drawbacks:

- **Volatility**: verify if subsequent operations reuse or overwrite "temp".
- **Ambiguity**: If multiple apps are installed from different URLs, the "temp" bucket concept breaks down or becomes ambiguous.
- **Traceability**: Users cannot easily see which external buckets are currently in use.

A dedicated `buckets.json` registry file will solve these issues by maintaining a persistent mapping between bucket names and their URLs.

## Specification

### `buckets.json` Structure

A new file `buckets.json` will be maintained in the user's defined buckets directory (e.g., `~/.poks/buckets/buckets.json`).

The file content will be a JSON list of bucket objects. Using `mashumaro` for serialization/deserialization is recommended.

```json
[
  {
    "id": "e3b0c442",
    "name": "main",
    "url": "https://github.com/poks/main-bucket.git"
  },
  {
    "id": "8d969eef",
    "name": null,
    "url": "https://github.com/custom/bucket.git"
  }
]
```

- **id**: A deterministic hash (e.g., first 8-12 chars of SHA256) of the normalized bucket URL. This serves as the unique identifier and primary key for storage.
- **name**: An optional user-friendly alias. If not provided (null), the bucket is anonymous/ad-hoc.
- **url**: The git remote URL.

### Logic Changes

#### 1. Installing with a Bucket URL

When `poks install <app> --bucket <url>` is executed and `<url>` is detected as a URL:

1. **Hash the URL**: Compute the ID from the URL.
2. **Check Registry**: Read `buckets.json`.
    - If the ID exists, use the existing entry.
    - If not, create a new entry: `{ "id": <hash>, "name": null, "url": <url> }` and append it to `buckets.json`.
3. **Sync**: Clone/pull the bucket into `buckets_dir / <id>`. (Note: Using ID for directory name avoids collisions).

#### 2. Installing with a Bucket Name

When `poks install <app> --bucket <name>` is executed:

1. **Check Registry**: Read `buckets.json`.
2. **Lookup**: Find the entry where `name == <name>`.
    - If found, use its `id` and `url`.
    - Sync to `buckets_dir / <id>`.

#### 3. Listing Installed Apps

The `poks list` command should resolve the source bucket for each app.

- The app installation record (e.g., `.manifest.json` or a separate receipt) should store the `bucket_id`.
- When listing:
  - Lookup the `bucket_id` in `buckets.json`.
  - If the bucket has a `name`, display the `name`.
  - If the bucket has no `name` (is null), display the `url`.

#### 4. Bucket Synchronization

The `buckets.json` file becomes the source of truth. `search --update` will iterate through all entries in `buckets.json`, determine the local path (by `id`), and update the git repo.

## Backwards Compatibility

- Migration: Existing buckets in `buckets_dir` by name might need to be hashed and moved to `buckets_dir / <id>`, or we support a legacy mode where we look up by name in `buckets.json` but the path is still `buckets_dir / <name>`.
  - *Recommendation*: For simplicity, strictly migrate to `buckets_dir / <id>` to ensure uniformity.
- The `temp` bucket is removed.

## Implementation Plan

1. **Model Update**: Define `PoksBucketRegistry` or list of `PoksBucket` in `domain/models.py`. Update `PoksBucket` to include `id`.
2. **Registry Management**: Implement functions to read/write `buckets.json` in `bucket.py`.
3. **Install Logic**: Update `Poks.install_app` in `poks.py` to use the registry lookup/update logic, hash URLs to IDs, and use ID-based paths.
4. **List Command**: Update `Poks.list` to cross-reference `buckets.json` and display URL if name is missing.
5. **CLI**: Ensure CLI commands respect the new registry resource.

## Security Implications

- Hashing URLs avoids directory traversal issues with arbitrary URLs.
- Users should still verify the source of bucket URLs.

## Open Questions

- How to handle local directory paths passed as `--bucket`? (Should they be added to registry with `url=path`?)
- Should `poks bucket add` and `poks bucket list` commands be added? (Future scope)
